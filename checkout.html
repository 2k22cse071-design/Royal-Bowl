<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Royal Bowl</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f8f8;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-family: 'Poppins', sans-serif;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        #map {
            height: 300px;
            width: 100%;
            border-radius: 5px;
            margin-top: 10px;
        }

        .btn-confirm {
            background: #f42525;
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn-confirm:hover {
            background: #d01f1f;
        }

        .total-display {
            text-align: right;
            font-size: 1.2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .back-link {
            display: block;
            margin-bottom: 15px;
            color: #555;
            text-decoration: none;
        }
    </style>
</head>

<body>

    <div class="container">
        <a href="index.html" class="back-link">← Back to Menu</a>
        <h1>Checkout</h1>

        <div id="order-summary">
            <h3>Order Summary</h3>
            <div id="items-list"></div>
            <div class="total-display">Total: ₹<span id="checkout-total">0</span></div>
        </div>

        <form id="checkout-form">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="name" required placeholder="Enter your full name">
            </div>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="phone" required placeholder="Enter your phone number">
            </div>
            <div class="form-group">
                <label>Delivery Location (Drag marker to set location)</label>
                <div id="map"></div>
                <input type="text" id="address" placeholder="Selected Address" readonly
                    style="margin-top:10px; background:#eee;">
                <input type="hidden" id="coordinates">
            </div>

            <button type="submit" class="btn-confirm">Confirm Order</button>
        </form>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Load cart from localStorage (we need to pass cart data)
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        if (cart.length === 0) {
            alert("Cart is empty!");
            window.location.href = 'index.html';
        }

        // Display Items
        const itemsList = document.getElementById('items-list');
        cart.forEach(item => {
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.padding = '5px 0';
            div.innerHTML = `<span>${item.quantity}x ${item.name}</span> <span>₹${item.price * item.quantity}</span>`;
            itemsList.appendChild(div);
        });
        document.getElementById('checkout-total').innerText = total;

        // Initialize Map
        const map = L.map('map').setView([13.0827, 80.2707], 13); // Default to Chennai center
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const marker = L.marker([13.0827, 80.2707], { draggable: true }).addTo(map);

        function updateLocation(lat, lng) {
            document.getElementById('coordinates').value = JSON.stringify({ lat, lng });
            // Ideally reverse geocode here, but for now just showing coords or specific string
            // Using a simple fetch to nominatim for address
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('address').value = data.display_name;
                })
                .catch(() => {
                    document.getElementById('address').value = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
                });
        }

        // Initial update
        updateLocation(13.0827, 80.2707);

        marker.on('dragend', function (e) {
            const { lat, lng } = e.target.getLatLng();
            updateLocation(lat, lng);
        });

        map.on('click', function (e) {
            const { lat, lng } = e.latlng;
            marker.setLatLng([lat, lng]);
            updateLocation(lat, lng);
        });

        // Try to get user's current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                map.setView([latitude, longitude], 15);
                marker.setLatLng([latitude, longitude]);
                updateLocation(latitude, longitude);
            });
        }

        // Handle Form Submit
        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const coordinates = JSON.parse(document.getElementById('coordinates').value);

            const orderData = {
                customer_name: name,
                customer_phone: phone,
                address: address,
                coordinates: coordinates,
                total_amount: total,
                items: cart.map(i => ({ name: i.name, quantity: i.quantity, price: i.price }))
            };

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();
                if (response.ok) {
                    alert(`Order Placed Successfully! Order ID: ${result.orderId}`);
                    localStorage.removeItem('cart');
                    window.location.href = 'index.html';
                } else {
                    alert(`Failed to place order: ${result.message}`);
                }
            } catch (error) {
                console.error("Error placing order:", error);
                alert("Network error.");
            }
        });
    </script>
    <script>
        // ... (existing script)
    </script>
    <div style="text-align: center; margin-top: 20px; color: #888; font-size: 0.8rem;">
        App Version: 1.2 (Safe Mode Active)
    </div>
</body>

</html>